<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:Firebasemauiapp.StorePage"
             xmlns:converters="clr-namespace:Firebasemauiapp.Converters"
             x:Class="Firebasemauiapp.StorePage.StorePage"
             BackgroundColor="#F5F5F5"
             Shell.NavBarIsVisible="False"
             Shell.TabBarIsVisible="False"
             Title="Store">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter"/>
            <converters:BoolToOpacityConverter x:Key="BoolToOpacityConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid RowDefinitions="*">
        <!-- Forest Background -->
        <Image Source="main_bg.png"
               Aspect="AspectFill"
               Grid.RowSpan="1"/>

        <Grid RowDefinitions="Auto,*,Auto">
            <!-- Header Section with forest theme -->
            <Grid Grid.Row="0"
                  Padding="20,50,20,20">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Back button & Coin Display -->
                <Grid Grid.Row="0"
                      ColumnDefinitions="Auto,*,Auto"
                      Margin="0,0,0,10">
                    <!-- Back Button -->
                    <ImageButton Grid.Column="0"
                                 Source="back.png"
                                 WidthRequest="60"
                                 HeightRequest="60"
                                 HorizontalOptions="Start"
                                 VerticalOptions="Center"
                                 BackgroundColor="Transparent"
                                 Clicked="OnBackClicked"/>

                    <!-- My Seeds Label -->
                    <Border Grid.Column="2"
                            BackgroundColor="White"
                            Padding="12,8"
                            HorizontalOptions="End"
                            VerticalOptions="Center"
                            TranslationX="30">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="16"/>
                        </Border.StrokeShape>
                        <VerticalStackLayout Spacing="4"
                                             HorizontalOptions="End">
                            <Label Text="My Seeds"
                                   FontSize="20"
                                   TextColor="#50A65D"
                                   HorizontalOptions="End"/>
                            <HorizontalStackLayout Spacing="6"
                                                   HorizontalOptions="End">
                                <Image Source="coin.png"
                                       WidthRequest="24"
                                       HeightRequest="24"
                                       VerticalOptions="Center"/>
                                <Label Text="{Binding Coin}"
                                       FontSize="20"
                                       FontAttributes="Bold"
                                       TextColor="#50A65D"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!-- Plant with Pot -->
                <Grid Grid.Row="1"
                      WidthRequest="200"
                      HeightRequest="300"
                      HorizontalOptions="Center"
                      Margin="0,10,0,0">
                    <!-- Pot -->
                    <Image Source="{Binding CurrentPot}"
                           WidthRequest="220"
                           HeightRequest="220"
                           VerticalOptions="End"
                           HorizontalOptions="Center"
                           Margin="0,0,0,10"
                           TranslationY="50"/>
                    <!-- Plant -->
                    <Image Source="{Binding PlantImage}"
                           WidthRequest="250"
                           HeightRequest="250"
                           VerticalOptions="Start"
                           HorizontalOptions="Center"
                           TranslationY="20"/>
                </Grid>
            </Grid>

            <!-- Tab Navigation -->
            <Grid Grid.Row="1"
                  ColumnDefinitions="*,*"
                  ColumnSpacing="8"
                  Margin="0,0,0,0"
                  Padding="8,0"
                  VerticalOptions="Start">
                <!-- Store Tab -->
                <Border Grid.Column="0"
                        BackgroundColor="White"
                        Padding="12,10"
                        HeightRequest="60">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="Black"
                                Opacity="0.15"
                                Radius="8"
                                Offset="0,2"/>
                    </Border.Shadow>
                    <Border.Triggers>
                        <DataTrigger TargetType="Border"
                                     Binding="{Binding IsStoreTabSelected}"
                                     Value="False">
                            <Setter Property="BackgroundColor"
                                    Value="#D4E8C8"/>
                            <Setter Property="Shadow">
                                <Shadow Opacity="0"/>
                            </Setter>
                        </DataTrigger>
                    </Border.Triggers>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SelectStoreTabCommand}"/>
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="6"
                                           HorizontalOptions="Center">
                        <Image WidthRequest="24"
                               HeightRequest="24"
                               VerticalOptions="Center">
                            <Image.Triggers>
                                <DataTrigger TargetType="Image"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="True">
                                    <Setter Property="Source"
                                            Value="store_green.png"/>
                                </DataTrigger>
                                <DataTrigger TargetType="Image"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="False">
                                    <Setter Property="Source"
                                            Value="store_white.png"/>
                                </DataTrigger>
                            </Image.Triggers>
                        </Image>
                        <Label Text="Store"
                               FontSize="18"
                               FontAttributes="Bold"
                               VerticalOptions="Center">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="True">
                                    <Setter Property="TextColor"
                                            Value="#50A65D"/>
                                </DataTrigger>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="False">
                                    <Setter Property="TextColor"
                                            Value="White"/>
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </HorizontalStackLayout>
                </Border>

                <!-- My Items Tab -->
                <Border Grid.Column="1"
                        BackgroundColor="White"
                        Padding="12,10"
                        HeightRequest="60">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="Black"
                                Opacity="0.15"
                                Radius="8"
                                Offset="0,2"/>
                    </Border.Shadow>
                    <Border.Triggers>
                        <DataTrigger TargetType="Border"
                                     Binding="{Binding IsStoreTabSelected}"
                                     Value="True">
                            <Setter Property="BackgroundColor"
                                    Value="#D4E8C8"/>
                            <Setter Property="Shadow">
                                <Shadow Opacity="0"/>
                            </Setter>
                        </DataTrigger>
                    </Border.Triggers>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding SelectMyItemsTabCommand}"/>
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="6"
                                           HorizontalOptions="Center">
                        <Image WidthRequest="24"
                               HeightRequest="24"
                               VerticalOptions="Center">
                            <Image.Triggers>
                                <DataTrigger TargetType="Image"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="True">
                                    <Setter Property="Source"
                                            Value="myitem_white.png"/>
                                </DataTrigger>
                                <DataTrigger TargetType="Image"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="False">
                                    <Setter Property="Source"
                                            Value="myitem_green.png"/>
                                </DataTrigger>
                            </Image.Triggers>
                        </Image>
                        <Label Text="My Items"
                               FontSize="18"
                               FontAttributes="Bold"
                               VerticalOptions="Center">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="False">
                                    <Setter Property="TextColor"
                                            Value="#50A65D"/>
                                </DataTrigger>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsStoreTabSelected}"
                                             Value="True">
                                    <Setter Property="TextColor"
                                            Value="White"/>
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                    </HorizontalStackLayout>
                </Border>
            </Grid>

            <!-- Content Section -->
            <Border Grid.Row="1"
                    BackgroundColor="White"
                    StrokeThickness="0"
                    VerticalOptions="FillAndExpand"
                    Margin="0,50,0,0">
                <ScrollView>
                    <VerticalStackLayout Spacing="0"
                                         Padding="20,20,20,20">
                        <!-- Store Items (visible when Store tab selected) -->
                        <FlexLayout Direction="Row"
                                    Wrap="Wrap"
                                    JustifyContent="Start"
                                    AlignItems="Start"
                                    BindableLayout.ItemsSource="{Binding AvailableStoreItems}"
                                    IsVisible="{Binding IsStoreTabSelected}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="White"
                                            Stroke="#E0E0E0"
                                            StrokeThickness="1"
                                            Margin="5"
                                            Padding="8"
                                            WidthRequest="160"
                                            FlexLayout.Basis="48%">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12"/>
                                        </Border.StrokeShape>
                                        <Border.Shadow>
                                            <Shadow Brush="Black"
                                                    Opacity="0.2"
                                                    Radius="10"
                                                    Offset="0,3"/>
                                        </Border.Shadow>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.PurchaseItemCommand}"
                                                                  CommandParameter="{Binding .}"/>
                                        </Border.GestureRecognizers>

                                        <VerticalStackLayout Spacing="8">
                                            <!-- Item Image -->
                                            <Image Source="{Binding Image}"
                                                   WidthRequest="80"
                                                   HeightRequest="80"
                                                   HorizontalOptions="Center"
                                                   Aspect="AspectFit"
                                                   Opacity="{Binding IsPurchased, Converter={StaticResource BoolToOpacityConverter}}"/>

                                            <!-- Item Name -->
                                            <Label Text="{Binding Name}"
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   TextColor="#8FB78F"
                                                   HorizontalOptions="Center"
                                                   HorizontalTextAlignment="Center"/>

                                            <!-- Price or Purchased Status -->
                                            <HorizontalStackLayout Spacing="4"
                                                                   HorizontalOptions="Center">
                                                <Label Text="Purchased"
                                                       FontSize="30"
                                                       FontAttributes="Bold"
                                                       TextColor="#999999"
                                                       VerticalOptions="Center"
                                                       IsVisible="{Binding IsPurchased}"/>

                                                <HorizontalStackLayout Spacing="4"
                                                                       IsVisible="{Binding IsPurchased, Converter={StaticResource InvertedBoolConverter}}">
                                                    <Image Source="coin.png"
                                                           WidthRequest="30"
                                                           HeightRequest="30"
                                                           VerticalOptions="Center"/>
                                                    <Label Text="{Binding Price}"
                                                           FontSize="24"
                                                           FontAttributes="Bold"
                                                           TextColor="#8FB78F"
                                                           VerticalOptions="Center"/>
                                                </HorizontalStackLayout>
                                            </HorizontalStackLayout>
                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>

                        <!-- My Items (visible when My Items tab selected) -->
                        <FlexLayout Direction="Row"
                                    Wrap="Wrap"
                                    JustifyContent="Start"
                                    AlignItems="Start"
                                    BindableLayout.ItemsSource="{Binding MyItems}"
                                    IsVisible="{Binding IsStoreTabSelected, Converter={StaticResource InvertedBoolConverter}}">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="White"
                                            Stroke="#E0E0E0"
                                            StrokeThickness="1"
                                            Margin="5"
                                            Padding="8"
                                            WidthRequest="160"
                                            FlexLayout.Basis="48%">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12"/>
                                        </Border.StrokeShape>
                                        <Border.Shadow>
                                            <Shadow Brush="Black"
                                                    Opacity="0.2"
                                                    Radius="10"
                                                    Offset="0,3"/>
                                        </Border.Shadow>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.UseItemCommand}"
                                                                  CommandParameter="{Binding .}"/>
                                        </Border.GestureRecognizers>

                                        <VerticalStackLayout Spacing="8">
                                            <Image Source="{Binding Image}"
                                                   WidthRequest="80"
                                                   HeightRequest="80"
                                                   HorizontalOptions="Center"
                                                   Aspect="AspectFit"/>

                                            <Label Text="{Binding Name}"
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   TextColor="#8FB78F"
                                                   HorizontalOptions="Center"
                                                   HorizontalTextAlignment="Center"/>

                                            <Label Text="Tap to use"
                                                   FontSize="16"
                                                   TextColor="#50A65D"
                                                   HorizontalOptions="Center"/>
                                        </VerticalStackLayout>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                    </VerticalStackLayout>
                </ScrollView>
            </Border>
        </Grid>

    </Grid>
</ContentPage>