<?xml version="1.0" encoding="utf-8"?>
<ContentPage
    x:Class="Firebasemauiapp.QuestPage.QuestPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:Firebasemauiapp.Converters;assembly=Firebasemauiapp"
    x:Name="Root"
    Title="Quests"
    BackgroundImageSource="main_bg.png"
    Shell.NavBarIsVisible="False"
    Shell.BackgroundColor="Transparent">

    <ContentPage.Resources>
        <converters:ProgressToDoubleConverter x:Key="ProgressToDoubleConverter"/>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"
                                         TrueColor="#4CAF50"
                                         FalseColor="Transparent"/>
    </ContentPage.Resources>

    <Grid RowDefinitions="80,*">
        <!-- Back Button -->
        <ImageButton Source="back.png"
                     Grid.Row="0"
                     WidthRequest="60"
                     HeightRequest="60"
                     HorizontalOptions="Start"
                     VerticalOptions="Start"
                     Margin="10,24,0,0"
                     Clicked="OnBackClicked"/>
        <!-- Main content area -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Padding="20"
                                 Spacing="20"
                                 Margin="0,10,0,40">


                <!-- Header - Hi Username -->
                <Label Text="{Binding UserName, StringFormat='Hi, {0}'}"
                       FontAttributes="Bold"
                       FontSize="36"
                       HorizontalOptions="Start"
                       TextColor="White"
                       Margin="0,10,0,0"/>

                <!-- Character/Plant with Pot -->
                <Grid WidthRequest="300"
                      HeightRequest="280"
                      HorizontalOptions="Center"
                      Margin="0,10,0,0">
                    <!-- Plant (render first, front of pot) -->
                    <Image Source="{Binding CurrentPlant}"
                           WidthRequest="240"
                           HeightRequest="240"
                           VerticalOptions="Start"
                           HorizontalOptions="Center"
                           TranslationY="-34"
                           ZIndex="1"/>
                    <!-- Pot (render second, in behind plant) -->
                    <Image Source="{Binding CurrentPot}"
                           WidthRequest="240"
                           HeightRequest="160"
                           VerticalOptions="End"
                           HorizontalOptions="Center"
                           ZIndex="0"/>
                </Grid>

                <!-- Daily Goals Progress Bar -->
                <Border BackgroundColor="White"
                        StrokeThickness="0"
                        Padding="16,12"
                        Margin="0,10,0,10">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="20"/>
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="Black"
                                Opacity="0.1"
                                Radius="10"
                                Offset="0,2"/>
                    </Border.Shadow>
                    <Grid RowDefinitions="Auto,Auto"
                          ColumnDefinitions="*,Auto">
                        <!-- "Daily Goals" text -->
                        <Label Grid.Row="0"
                               Grid.Column="0"
                               Text="Daily Goals"
                               FontSize="14"
                               FontAttributes="Bold"
                               TextColor="#6B9B6B"
                               VerticalOptions="Center"/>

                        <!-- Timer text -->
                        <Label Grid.Row="0"
                               Grid.Column="1"
                               Text="{Binding TimeUntilReset}"
                               FontSize="12"
                               TextColor="#999999"
                               VerticalOptions="Center"/>

                        <!-- Progress bar with icons -->
                        <Grid Grid.Row="1"
                              Grid.Column="0"
                              Grid.ColumnSpan="2"
                              Margin="0,8,0,0"
                              ColumnDefinitions="Auto,*,Auto,*,Auto">

                            <!-- Left icon (check) -->
                            <Border Grid.Column="0"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    BackgroundColor="#90C590"
                                    StrokeThickness="2"
                                    Stroke="White">
                                <Border.StrokeShape>
                                    <Ellipse/>
                                </Border.StrokeShape>
                                <Image Source="check.png"
                                       WidthRequest="24"
                                       HeightRequest="24"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Border>

                            <!-- Progress line 1 -->
                            <BoxView Grid.Column="1"
                                     HeightRequest="4"
                                     BackgroundColor="{Binding ProgressColor1}"
                                     VerticalOptions="Center"
                                     Margin="4,0"/>

                            <!-- Center icon (plant/character) -->
                            <Border Grid.Column="2"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    BackgroundColor="White"
                                    StrokeThickness="2"
                                    Stroke="{Binding ProgressBorder2}">
                                <Border.StrokeShape>
                                    <Ellipse/>
                                </Border.StrokeShape>
                                <Image Source="{Binding CurrentPlant}"
                                       WidthRequest="30"
                                       HeightRequest="30"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Border>

                            <!-- Progress line 2 -->
                            <BoxView Grid.Column="3"
                                     HeightRequest="4"
                                     BackgroundColor="{Binding ProgressColor2}"
                                     VerticalOptions="Center"
                                     Margin="4,0"/>

                            <!-- Right icon (reward) -->
                            <Border Grid.Column="4"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    BackgroundColor="White"
                                    StrokeThickness="2"
                                    Stroke="{Binding ProgressBorder3}">
                                <Border.StrokeShape>
                                    <Ellipse/>
                                </Border.StrokeShape>
                                <Image Source="giftbox.png"
                                       WidthRequest="24"
                                       HeightRequest="24"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </Border>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Quests list -->
                <VerticalStackLayout Spacing="12">
                    <CollectionView ItemsSource="{Binding Quests}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Border BackgroundColor="{Binding BorderColor}"
                                        Opacity="{Binding BorderOpacity}"
                                        StrokeThickness="0"
                                        Padding="16"
                                        Margin="0,0,0,12">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="20"/>
                                    </Border.StrokeShape>
                                    <Grid ColumnDefinitions="Auto,*,Auto"
                                          RowDefinitions="Auto,Auto">
                                        <!-- Icon -->
                                        <Border Grid.Row="0"
                                                Grid.RowSpan="2"
                                                Grid.Column="0"
                                                WidthRequest="50"
                                                HeightRequest="50"
                                                BackgroundColor="#90C590"
                                                StrokeThickness="0"
                                                Margin="0,0,12,0"
                                                VerticalOptions="Center">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="12"/>
                                            </Border.StrokeShape>
                                            <Image Source="{Binding Icon}"
                                                   WidthRequest="30"
                                                   HeightRequest="30"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"/>
                                        </Border>

                                        <!-- Title -->
                                        <Label Grid.Row="0"
                                               Grid.Column="1"
                                               Text="{Binding Title}"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               TextColor="White"/>

                                        <!-- Progress fraction and action button -->
                                        <Grid Grid.Row="1"
                                              Grid.Column="1"
                                              ColumnDefinitions="Auto,*">
                                            <!-- Progress bar background -->
                                            <Border Grid.Column="0"
                                                    BackgroundColor="#6B9B6B"
                                                    HeightRequest="24"
                                                    Padding="40,0"
                                                    StrokeThickness="0"
                                                    VerticalOptions="Center">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="12"/>
                                                </Border.StrokeShape>
                                                <Label Text="{Binding ProgressText}"
                                                       FontSize="12"
                                                       FontAttributes="Bold"
                                                       TextColor="White"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"/>
                                            </Border>
                                        </Grid>

                                        <!-- Action button -->
                                        <Button Grid.Row="1"
                                                Grid.Column="2"
                                                Text="{Binding ButtonText}"
                                                BackgroundColor="{Binding ButtonColor}"
                                                TextColor="{Binding ButtonTextColor}"
                                                FontSize="14"
                                                FontAttributes="Bold"
                                                CornerRadius="16"
                                                Padding="20,8"
                                                HeightRequest="40"
                                                VerticalOptions="Center"
                                                Clicked="OnQuestActionClicked"/>

                                        <!-- Reward badge -->
                                        <HorizontalStackLayout Grid.Row="0"
                                                               Grid.Column="2"
                                                               Spacing="4"
                                                               VerticalOptions="Center">
                                            <Label Text="{Binding Reward}"
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="#2F6B4F"/>
                                            <Label Text="ðŸª™"
                                                   FontSize="16"/>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Loading indicator -->
                <ActivityIndicator IsRunning="{Binding IsBusy}"
                                   IsVisible="{Binding IsBusy}"
                                   Color="White"
                                   HeightRequest="40"/>
            </VerticalStackLayout>
        </ScrollView>


    </Grid>
</ContentPage>
