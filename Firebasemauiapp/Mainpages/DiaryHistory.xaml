<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Firebasemauiapp.Converters"
             x:Class="Firebasemauiapp.Mainpages.DiaryHistory"
             Title="Diary History"
             BackgroundColor="#edf6e4">

    <ContentPage.Resources>
        <converters:SeeMoreLinesConverter x:Key="SeeMoreLinesConverter" />
        <converters:SeeMoreTextConverter x:Key="SeeMoreTextConverter" />
    </ContentPage.Resources>
    
    <Grid>
        <!-- Loading Indicator -->
        <ActivityIndicator IsVisible="{Binding IsLoading}" 
                          IsRunning="{Binding IsLoading}"
                          Color="Blue"
                          VerticalOptions="Center"
                          HorizontalOptions="Center" />
        
        <!-- Empty State -->
        <StackLayout IsVisible="{Binding IsEmpty}" 
                    VerticalOptions="Center" 
                    HorizontalOptions="Center"
                    Padding="20">
            <Image Source="empty.png" 
                  HeightRequest="100" 
                  WidthRequest="100"/>
            <Label Text="No diary entries found" 
                  FontSize="18" 
                  HorizontalOptions="Center" 
                  TextColor="Gray"/>
            <Label Text="Start writing your first diary!" 
                  FontSize="14" 
                  HorizontalOptions="Center" 
                  TextColor="Gray"/>
        </StackLayout>
        
        <!-- Diary List -->
        <RefreshView Command="{Binding LoadDiaryHistoryCommand}" 
                    IsRefreshing="{Binding IsLoading}"
                    IsVisible="{Binding IsEmpty, Converter={StaticResource InvertedBoolConverter}}">
            
            <CollectionView ItemsSource="{Binding DiaryGroups}"
                           BackgroundColor="Transparent">
                
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="0,10,0,10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- Date Header -->
                            <Label Grid.Row="0"
                                  Text="{Binding DateString}"
                                  FontSize="16"
                                  FontAttributes="Bold"
                                  TextColor="DarkBlue"
                                  Margin="10,0,0,10"/>
                            <!-- Diaries for this date -->
                            <CollectionView Grid.Row="1"
                                            ItemsSource="{Binding Diaries}"
                                            SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border BackgroundColor="#F8FAED"
                                               Stroke="#50A65D"
                                               StrokeThickness="1"
                                               Margin="0,0,0,20"
                                               Padding="18,16,18,12">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="14"/>
                                            </Border.StrokeShape>
                                            <Grid RowSpacing="8">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Content -->
                                <Label Grid.Row="0"
                                    Text="{Binding Content}"
                                    FontSize="15"
                                    TextColor="Black"
                                    LineBreakMode="WordWrap"
                                    Margin="0,0,0,8"
                                    MaxLines="{Binding IsExpanded, Converter={StaticResource SeeMoreLinesConverter}}"/>
                                                <!-- Bottom row: icon, score, see more -->
                                                <Grid Grid.Row="2" ColumnSpacing="8">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <!-- Icon (left) -->
                                                    <Image Grid.Column="0" Source="{Binding MoodImage}" HeightRequest="48" WidthRequest="48" VerticalOptions="End"/>
                                                    <!-- Score (center) -->
                                                    <Border Grid.Column="1" BackgroundColor="#E6F4EA" Stroke="#50A65D" StrokeThickness="1" Padding="8,2" HorizontalOptions="Center" VerticalOptions="End" StrokeShape="RoundRectangle 8">
                                                        <Label Text="{Binding SentimentScore, StringFormat='Mental Wellness Score : {0}'}" FontSize="14" TextColor="#50A65D" HorizontalOptions="Center"/>
                                                    </Border>
                                                    <!-- See more/less (right) -->
                            <Button Grid.Column="2"
                                Text="{Binding IsExpanded, Converter={StaticResource SeeMoreTextConverter}}"
                                FontSize="13"
                                BackgroundColor="Transparent"
                                TextColor="#50A65D"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ToggleExpandCommand}"
                                CommandParameter="{Binding .}"/>
                                                </Grid>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>