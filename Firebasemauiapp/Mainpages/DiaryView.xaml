<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Firebasemauiapp.Mainpages.DiaryView"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:Firebasemauiapp.Converters"
             Title="DiaryView"
             BackgroundColor="{Binding MoodBackgroundColor}"
             Shell.NavBarIsVisible="False">
    <ContentPage.Resources>
        <conv:MoodNameToImageConverter x:Key="MoodNameToImageConverter"/>
    </ContentPage.Resources>
    
    <Grid>
        <!-- ✅ Main Content -->
        <Grid RowDefinitions="Auto,*"
              Padding="20"
              RowSpacing="16"
              IsVisible="{Binding IsAnalyzing, Converter={StaticResource InvertedBoolConverter}}">

            <!-- Header Section -->
            <Grid Grid.Row="0"
                  RowDefinitions="Auto,Auto"
                  ColumnDefinitions="Auto,*"
                  RowSpacing="8">
                
                <!-- Back Button -->
                <ImageButton Source="back.png"
                             Clicked="OnBackClicked"
                             BackgroundColor="Transparent"
                             WidthRequest="60"
                             HeightRequest="60"
                             Grid.Row="0"
                             Grid.Column="0"/>
                
                <!-- Date with Calendar Icon -->
                <HorizontalStackLayout Grid.Row="1"
                                       Grid.Column="0"
                                       Grid.ColumnSpan="2"
                                       Spacing="8">
                    <Image Source="calendar.png"
                           WidthRequest="24"
                           HeightRequest="24"
                           VerticalOptions="Center"/>
                    <Label x:Name="DateLabel"
                           TextColor="White"
                           FontSize="18"
                           VerticalOptions="Center"
                           Opacity="0.9"/>
                </HorizontalStackLayout>
            </Grid>

            <!-- Content Section -->
            <Grid Grid.Row="1"
                  RowDefinitions="Auto,*,Auto,Auto"
                  RowSpacing="16">

                <!-- Mood Indicator -->
                <Border Grid.Row="0"
                        BackgroundColor="White"
                        StrokeThickness="0"
                        WidthRequest="50"
                        HeightRequest="50"
                        HorizontalOptions="Start">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Image Source="{Binding Mood.Name, Converter={StaticResource MoodNameToImageConverter}}"
                           Aspect="AspectFit"
                           Margin="6"/>
                </Border>

                <!-- Diary Text Editor -->
                <Border Grid.Row="1"
                        x:Name="EditorBorder"
                        BackgroundColor="Transparent"
                        StrokeThickness="0">
                    <Editor x:Name="DiaryEntry"
                            BackgroundColor="Transparent"
                            Placeholder="Share something good..."
                            PlaceholderColor="#CCFFFFFF"
                            Text="{Binding DiaryContent}"
                            FontSize="16"
                            TextColor="White"
                            VerticalOptions="FillAndExpand"
                            AutoSize="TextChanges"/>
                </Border>

                <!-- Image Upload Section (Conditionally Visible) -->
                <Border Grid.Row="2"
                        x:Name="ImageBorder"
                        BackgroundColor="White"
                        StrokeThickness="0"
                        HeightRequest="150"
                        IsVisible="{Binding IsImageSectionVisible}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="16"/>
                    </Border.StrokeShape>
                    
                    <Grid>
                        <!-- Show image if uploaded -->
                        <Image Source="{Binding ImageUrl}"
                               Aspect="AspectFill"
                               IsVisible="{Binding ImageUrl, Converter={StaticResource StringToBoolConverter}}">
                            <Image.Clip>
                                <RoundRectangleGeometry CornerRadius="16"
                                                        Rect="0,0,1000,150"/>
                            </Image.Clip>
                        </Image>
                        
                        <!-- Upload button placeholder (when no image) -->
                        <VerticalStackLayout VerticalOptions="Center"
                                             HorizontalOptions="Center"
                                             Spacing="8"
                                             IsVisible="{Binding ImageUrl, Converter={StaticResource InvertedBoolConverter}}">
                            <Border BackgroundColor="Transparent"
                                    Stroke="#FEAA3A"
                                    StrokeThickness="2"
                                    WidthRequest="60"
                                    HeightRequest="60"
                                    HorizontalOptions="Center">
                                <Border.StrokeShape>
                                    <Ellipse/>
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding UploadImageCommand}"/>
                                </Border.GestureRecognizers>
                                <Image Source="imgicon.png"
                                       WidthRequest="32"
                                       HeightRequest="32"/>
                            </Border>
                        </VerticalStackLayout>
                    </Grid>
                </Border>

                <!-- Action Buttons -->
                <Grid Grid.Row="3"
                      ColumnDefinitions="Auto,*"
                      ColumnSpacing="12"
                      Margin="0,8,0,0">

                    <!-- Toggle Image Section Button -->
                    <Border Grid.Column="0"
                            BackgroundColor="White"
                            Stroke="#FEAA3A"
                            StrokeThickness="2"
                            WidthRequest="56"
                            HeightRequest="56">
                        <Border.StrokeShape>
                            <Ellipse/>
                        </Border.StrokeShape>
                        <Border.Shadow>
                            <Shadow Brush="Black"
                                    Radius="12"
                                    Offset="0,4"
                                    Opacity="0.2"/>
                        </Border.Shadow>
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleImageSectionCommand}"/>
                        </Border.GestureRecognizers>

                        <Image Source="imgicon.png"
                               WidthRequest="28"
                               HeightRequest="28"/>
                    </Border>

                    <!-- Next Button -->
                    <Button Grid.Column="1"
                            Text="Next ➤"
                            Command="{Binding AnalyzeContentCommand}"
                            BackgroundColor="White"
                            TextColor="#FEAA3A"
                            FontFamily="contextfont"
                            FontSize="18"
                            FontAttributes="Bold"
                            CornerRadius="16"
                            HeightRequest="56">
                        <Button.Shadow>
                            <Shadow Brush="Black"
                                    Radius="12"
                                    Offset="0,4"
                                    Opacity="0.2"/>
                        </Button.Shadow>
                    </Button>
                </Grid>
            </Grid>
        </Grid>

        <!-- ✅ Loading Overlay (Separate Layer) -->
        <Grid IsVisible="{Binding IsAnalyzing}"
              BackgroundColor="#80000000">
            <VerticalStackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="16">
                <ActivityIndicator IsRunning="True"
                                   Color="White"
                                   WidthRequest="60"
                                   HeightRequest="60"/>
                <Label Text="Analyzing your diary..."
                       TextColor="White"
                       FontSize="16"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>