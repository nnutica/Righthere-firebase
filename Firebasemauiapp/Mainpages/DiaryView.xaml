<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Firebasemauiapp.Mainpages.DiaryView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:Firebasemauiapp.Converters"
    Title="DiaryView"
    BackgroundColor="#FEAA3A"
    Shell.NavBarIsVisible="False">
    <ContentPage.Resources>
        <conv:MoodNameToImageConverter x:Key="MoodNameToImageConverter"/>
    </ContentPage.Resources>
    <!-- Layout: Row 0 Header, Row 1 Content (3 sub-rows) -->
    <Grid RowDefinitions="Auto,*"
          Padding="20"
          RowSpacing="12">
        <!-- Header: current date/time -->
        <Grid Grid.Row="0"
              RowDefinitions="Auto,Auto"
              ColumnDefinitions="Auto,*"
              Margin="0,0,0,8">
            <Button Text="â†"
                    Clicked="OnBackClicked"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    FontSize="22"
                    Padding="0"
                    WidthRequest="36"
                    HeightRequest="36"/>
            <Label x:Name="DateLabel"
                   Grid.ColumnSpan="2"
                   Grid.Row="1"
                   TextColor="White"
                   FontSize="14"
                   Opacity="0.9"
                   Margin="0,4,0,0"/>
        </Grid>

        <!-- Content area split into 3 rows -->
        <Grid Grid.Row="1"
              RowDefinitions="Auto,*,Auto,Auto"
              ColumnDefinitions="*,*,*,*,*,*,*,*,*,*,*,*"
              RowSpacing="12">
            <!-- New Row: Selected Mood indicator -->
            <Grid Grid.Row="0"
                  Grid.ColumnSpan="12"
                  ColumnDefinitions="Auto,*"
                  Margin="0,0,0,4">
                <Border BackgroundColor="White"
                        WidthRequest="48"
                        HeightRequest="48"
                        VerticalOptions="Start">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="12"/>
                    </Border.StrokeShape>
                    <Image Source="{Binding Mood.Name, Converter={StaticResource MoodNameToImageConverter}}"
                           Margin="8"
                           Aspect="AspectFit"/>
                </Border>
            </Grid>
            <!-- Row 0: Entry Field (no background) -->
            <Border Grid.Row="1"
                    Grid.ColumnSpan="12"
                    Margin="0,6,0,10"
                    StrokeThickness="0"
                    BackgroundColor="Transparent"
                    Padding="10"
                    VerticalOptions="FillAndExpand"
                    HeightRequest="300">
                <Editor x:Name="DiaryEntry"
                        BackgroundColor="Transparent"
                        Placeholder="share something good..."
                        Text="{Binding DiaryContent}"
                        TextColor="Black"
                        VerticalOptions="FillAndExpand"
                        VerticalTextAlignment="Start"/>
            </Border>

            <!-- Row 1: Image preview (optimized for portrait with AspectFit and taller frame) -->
            <Border Grid.Row="2"
                    Grid.ColumnSpan="12"
                    BackgroundColor="#FFFFFFFF"
                    StrokeThickness="1"
                    Stroke="#50A65D"
                    Padding="6"
                    Margin="0,4,0,0"
                    HeightRequest="360"
                    IsVisible="True">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="16"/>
                </Border.StrokeShape>
                <Border.Triggers>
                    <DataTrigger TargetType="Border"
                                 Binding="{Binding ImageUrl}"
                                 Value="">
                        <Setter Property="IsVisible"
                                Value="False"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Border"
                                 Binding="{Binding ImageUrl}"
                                 Value="{x:Null}">
                        <Setter Property="IsVisible"
                                Value="False"/>
                    </DataTrigger>
                </Border.Triggers>
                <Image Source="{Binding ImageUrl}"
                       Aspect="AspectFit"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       HeightRequest="408"/>
            </Border>

            <!-- Row 2: Action row: + icon (left) and Next (right) -->
            <Grid Grid.Row="3"
                  Grid.ColumnSpan="12"
                  ColumnDefinitions="Auto,Auto,*"
                  VerticalOptions="Center">
                <!-- + Image icon -->
                <ImageButton Grid.Column="0"
                             Source="imgicon.png"
                             BackgroundColor="White"
                             CornerRadius="12"
                             Padding="8"
                             WidthRequest="48"
                             HeightRequest="48"
                             Margin="0,0,10,0"
                             Command="{Binding UploadImageCommand}">
                    <ImageButton.Shadow>
                        <Shadow Brush="#40000000"
                                Radius="12"
                                Offset="0,4"
                                Opacity="0.35"/>
                    </ImageButton.Shadow>
                </ImageButton>

                <!-- Spinner next to + when uploading -->
                <ActivityIndicator Grid.Column="1"
                                   Margin="10,0,0,0"
                                   Color="#50A65D"
                                   IsRunning="{Binding IsUploadingImage}"
                                   IsVisible="{Binding IsUploadingImage}"/>

                <!-- Next button expanded to the right -->
                <Button Grid.Column="2"
                        x:Name="AnalyzeButton"
                        BackgroundColor="White"
                        TextColor="#FEAA3A"
                        Text="{Binding AnalyzeButtonText}"
                        Command="{Binding AnalyzeContentCommand}"
                        IsEnabled="{Binding IsAnalyzing, Converter={StaticResource InvertedBoolConverter}}"
                        CornerRadius="28"
                        HeightRequest="56"
                        HorizontalOptions="Fill"
                        VerticalOptions="Center"
                        FontAttributes="Bold"
                        FontSize="18">
                    <Button.Shadow>
                        <Shadow Brush="#40000000"
                                Radius="16"
                                Offset="0,4"
                                Opacity="0.35"/>
                    </Button.Shadow>
                </Button>
            </Grid>

            <!-- Loading Indicator under the row (if needed overlay could be used) -->
            <ActivityIndicator Grid.Row="3"
                               Grid.ColumnSpan="12"
                               Margin="10"
                               Color="White"
                               IsRunning="{Binding IsLoadingVisible}"
                               IsVisible="{Binding IsLoadingVisible}"/>
        </Grid>
    </Grid>
</ContentPage>