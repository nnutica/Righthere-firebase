<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Firebasemauiapp.Mainpages.DiaryView"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:conv="clr-namespace:Firebasemauiapp.Converters"
             Title="DiaryView"
             BackgroundColor="{Binding MoodBackgroundColor}"
             Shell.NavBarIsVisible="False">
    <ContentPage.Resources>
        <conv:MoodNameToImageConverter x:Key="MoodNameToImageConverter"/>
        <conv:ImageUrlToHeightConverter x:Key="ImageUrlToHeightConverter"/>
    </ContentPage.Resources>
    <Grid RowDefinitions="Auto,*"
          Padding="20"
          RowSpacing="12">

        <!-- Loading Indicator Overlay -->
        <ActivityIndicator Grid.RowSpan="2"
                           IsRunning="{Binding IsAnalyzing}"
                           IsVisible="{Binding IsAnalyzing}"
                           Color="White"
                           Scale="2"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           ZIndex="999"/>

        <!-- Header -->
        <Grid Grid.Row="0"
              RowDefinitions="Auto,Auto"
              ColumnDefinitions="Auto,*"
              Margin="0,0,0,12">
            <ImageButton Source="back.png"
                         Clicked="OnBackClicked"
                         BackgroundColor="Transparent"
                         WidthRequest="60"
                         HeightRequest="60"/>
            <Image Source="calendar.png"
                   Grid.Row="1"
                   Grid.Column="0"
                   WidthRequest="28"
                   HeightRequest="28"
                   Margin="0,4,8,0"/>
            <Label x:Name="DateLabel"
                   Grid.Column="1"
                   Grid.Row="1"
                   TextColor="White"
                   FontSize="20"
                   Opacity="0.9"
                   Margin="0,4,0,0"/>
        </Grid>
        <!-- Content with AbsoluteLayout for precise positioning -->
        <Grid Grid.Row="1"
              RowDefinitions="Auto,*,Auto,Auto"
              RowSpacing="12">

            <!-- Mood indicator -->
            <Border Grid.Row="0"
                    WidthRequest="50"
                    HeightRequest="50"
                    HorizontalOptions="Start">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12"/>
                </Border.StrokeShape>
                <Image Source="{Binding Mood.Name, Converter={StaticResource MoodNameToImageConverter}}"
                       Margin="8"
                       Aspect="AspectFit"
                       WidthRequest="40"
                       HeightRequest="40"/>
            </Border>

            <!-- Diary editor -->
            <Border Grid.Row="1"
                    x:Name="EditorBorder"
                    StrokeThickness="0"
                    BackgroundColor="Transparent"
                    Padding="10">
                <Editor x:Name="DiaryEntry"
                        BackgroundColor="Transparent"
                        Placeholder="share something good..."
                        PlaceholderColor="#FFDDDDDD"
                        Text="{Binding DiaryContent}"
                        FontSize="16"
                        FontAttributes="None"
                        TextColor="White"
                        VerticalOptions="FillAndExpand"
                        VerticalTextAlignment="Start"
                        AutoSize="TextChanges"/>
            </Border>

            <!-- Image area -->
            <Border Grid.Row="2"
                    x:Name="ImageBorder"
                    BackgroundColor="White"
                    StrokeThickness="0"
                    IsVisible="{Binding IsImageAreaEnabled}">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="20"/>
                </Border.StrokeShape>

                <Grid HeightRequest="150">
                    <!-- Upload Image Button (shown when no image) -->
                    <Border BackgroundColor="White"
                            Stroke="#FEAA3A"
                            StrokeThickness="2"
                            WidthRequest="100"
                            HeightRequest="100"
                            HorizontalOptions="Center"
                            VerticalOptions="Center">
                        <Border.Triggers>
                            <DataTrigger TargetType="Border"
                                         Binding="{Binding ImageUrl}"
                                         Value="">
                                <Setter Property="IsVisible"
                                        Value="True"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Border"
                                         Binding="{Binding ImageUrl}"
                                         Value="{x:Null}">
                                <Setter Property="IsVisible"
                                        Value="True"/>
                            </DataTrigger>
                        </Border.Triggers>

                        <Border.StrokeShape>
                            <Ellipse/>
                        </Border.StrokeShape>

                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding UploadImageCommand}"/>
                        </Border.GestureRecognizers>

                        <VerticalStackLayout VerticalOptions="Center"
                                             HorizontalOptions="Center"
                                             Spacing="8">
                            <Image Source="imgicon.png"
                                   WidthRequest="48"
                                   HeightRequest="48"
                                   HorizontalOptions="Center"
                                   Opacity="0.6"/>

                        </VerticalStackLayout>
                    </Border>

                    <!-- Uploaded Image (shown when image exists) -->
                    <Image Source="{Binding ImageUrl}"
                           Aspect="AspectFill"
                           HorizontalOptions="Fill"
                           VerticalOptions="Fill">
                        <Image.Clip>
                            <RoundRectangleGeometry CornerRadius="20"
                                                    Rect="0,0,1000,1000"/>
                        </Image.Clip>
                        <Image.Triggers>
                            <DataTrigger TargetType="Image"
                                         Binding="{Binding ImageUrl}"
                                         Value="">
                                <Setter Property="IsVisible"
                                        Value="False"/>
                            </DataTrigger>
                            <DataTrigger TargetType="Image"
                                         Binding="{Binding ImageUrl}"
                                         Value="{x:Null}">
                                <Setter Property="IsVisible"
                                        Value="False"/>
                            </DataTrigger>
                        </Image.Triggers>
                    </Image>
                </Grid>
            </Border>

            <!-- Action buttons -->
            <Grid Grid.Row="3"
                  ColumnDefinitions="Auto,*"
                  ColumnSpacing="12"
                  Margin="0,0,0,10">

                <Border Grid.Column="0"
                        BackgroundColor="White"
                        WidthRequest="56"
                        HeightRequest="56"
                        VerticalOptions="Center">
                    <Border.StrokeShape>
                        <Ellipse/>
                    </Border.StrokeShape>
                    <Border.Shadow>
                        <Shadow Brush="#40000000"
                                Radius="12"
                                Offset="0,4"
                                Opacity="0.35"/>
                    </Border.Shadow>
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnCancelClicked"/>
                    </Border.GestureRecognizers>

                    <Grid>
                        <!-- Image icon (shown when Image Area is disabled) -->
                        <Border BackgroundColor="White"
                                Stroke="#FEAA3A"
                                StrokeThickness="2"
                                WidthRequest="56"
                                HeightRequest="56"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                IsVisible="{Binding IsImageAreaEnabled, Converter={StaticResource InvertedBoolConverter}}">
                            <Border.StrokeShape>
                                <Ellipse/>
                            </Border.StrokeShape>
                            <Image Source="imgicon.png"
                                   WidthRequest="32"
                                   HeightRequest="32"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                        </Border>

                        <!-- X icon (shown when Image Area is enabled) -->
                        <Border BackgroundColor="#A5F88C"
                                Stroke="#FEAA3A"
                                StrokeThickness="2"
                                WidthRequest="56"
                                HeightRequest="56"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                IsVisible="{Binding IsImageAreaEnabled}">
                            <Border.StrokeShape>
                                <Ellipse/>
                            </Border.StrokeShape>
                            <Label Text="âœ•"
                                   FontSize="24"
                                   TextColor="#FEAA3A"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                        </Border>
                    </Grid>
                </Border>

                <Button Grid.Column="1"
                        x:Name="AnalyzeButton"
                        BackgroundColor="White"
                        TextColor="#FEAA3A"
                        Text="Next"
                        Command="{Binding AnalyzeContentCommand}"
                        IsEnabled="{Binding IsAnalyzing, Converter={StaticResource InvertedBoolConverter}}"
                        CornerRadius="16"
                        HeightRequest="50"
                        FontFamily="contextfont"
                        HorizontalOptions="Fill"
                        VerticalOptions="Center"
                        FontAttributes="Bold"
                        FontSize="20">
                    <Button.Shadow>
                        <Shadow Brush="#40000000"
                                Radius="16"
                                Offset="0,4"
                                Opacity="0.35"/>
                    </Button.Shadow>
                </Button>
            </Grid>

        </Grid>

    </Grid>
</ContentPage>