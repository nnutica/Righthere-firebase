<?xml version="1.0" encoding="utf-8" ?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:sfchart="clr-namespace:Syncfusion.Maui.Charts;assembly=Syncfusion.Maui.Charts"
             xmlns:sfgauges="clr-namespace:Syncfusion.Maui.Gauges;assembly=Syncfusion.Maui.Gauges"
             xmlns:conv="clr-namespace:Firebasemauiapp.Converters"
             x:Class="Firebasemauiapp.Mainpages.Dashboard"
             Shell.NavBarIsVisible="False"
             Title="Dashboard">
       <ContentPage.Resources>
              <ResourceDictionary>
                     <conv:ProgressToDoubleConverter x:Key="ProgressToDoubleConverter"/>
                     <conv:ScoreToHeightConverter x:Key="ScoreToHeightConverter"/>
              </ResourceDictionary>
       </ContentPage.Resources>
       <!-- Add bottom white rounded strip by wrapping content in a two-row Grid -->
       <Grid RowDefinitions="*,32">
              <ScrollView Grid.Row="0"
                          BackgroundColor="{Binding MoodBackgroundColor}">
                     <!-- Use Grid for structured layout -->
                     <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                           RowSpacing="16">
                            <!-- Header -->
                            <Grid Grid.Row="0"
                                  RowDefinitions="Auto"
                                  Padding="24,80,24,16">
                                   <!-- Title Row -->
                                   <Label Grid.Row="0"
                                          Text="Embracing the&#x0a;echoes of your&#x0a;week."
                                          FontSize="48"
                                          FontAttributes="Bold"
                                          TextColor="White"
                                          HorizontalOptions="Center"
                                          LineBreakMode="WordWrap"
                                          TranslationX="-5"/>
                            </Grid>

                            <!-- Overall Wellness Pulse Card -->
                            <Border Grid.Row="1"
                                    BackgroundColor="White"
                                    StrokeThickness="0"
                                    StrokeShape="RoundRectangle 18"
                                    Padding="20"
                                    Margin="24,0,24,12">
                                   <Grid RowDefinitions="Auto,Auto"
                                         ColumnDefinitions="Auto,*">
                                          <!-- Tree Image -->
                                          <Image Source="{Binding MostFrequentMoodImage}"
                                                 HeightRequest="100"
                                                 WidthRequest="100"
                                                 Grid.Row="0"
                                                 Grid.Column="0"
                                                 Grid.RowSpan="2"
                                                 VerticalOptions="Center"
                                                 Margin="0,0,16,0"/>

                                          <!-- Text Content -->
                                          <VerticalStackLayout Grid.Row="0"
                                                               Grid.Column="1"
                                                               Spacing="4">
                                                 <Label Text="Overall Wellness"
                                                        FontSize="16"
                                                        TextColor="#4A7BA7"
                                                        FontAttributes="Bold"/>
                                                 <Label Text="Pulse"
                                                        FontSize="16"
                                                        TextColor="#4A7BA7"
                                                        FontAttributes="Bold"/>
                                          </VerticalStackLayout>

                                          <!-- Score -->
                                          <HorizontalStackLayout Grid.Row="1"
                                                                 Grid.Column="1"
                                                                 Spacing="4"
                                                                 VerticalOptions="Center">
                                                 <Label Text="{Binding AverageSentimentScore, StringFormat='{0:F0}'}"
                                                        FontSize="60"
                                                        FontAttributes="Bold"
                                                        TextColor="#4A7BA7"
                                                        VerticalOptions="Center"/>
                                                 <Label Text="/10"
                                                        FontSize="24"
                                                        TextColor="#7A7A7A"
                                                        VerticalOptions="End"
                                                        Margin="0,0,0,8"/>
                                          </HorizontalStackLayout>
                                   </Grid>
                            </Border>

                            <!-- Weekly Pulse Section -->
                            <VerticalStackLayout Grid.Row="2"
                                                 Spacing="8"
                                                 Padding="24,0">
                                   <!-- Title outside card -->
                                   <Label Text="Weekly Pulse"
                                          FontSize="28"
                                          FontAttributes="Bold"
                                          TextColor="White"/>

                                   <!-- Weekly Pulse Card -->
                                   <Border BackgroundColor="White"
                                           StrokeThickness="0"
                                           StrokeShape="RoundRectangle 18"
                                           Padding="20">
                                          <VerticalStackLayout Spacing="12">
                                                 <!-- Header with date range and History link -->
                                                 <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                                                        <!-- Previous week button -->
                                                        <Button Text="&lt;&lt;"
                                                                FontSize="16"
                                                                TextColor="#4A7BA7"
                                                                BackgroundColor="Transparent"
                                                                FontAttributes="Bold"
                                                                WidthRequest="40"
                                                                Padding="0"
                                                                Grid.Column="0"
                                                                Command="{Binding PreviousWeekCommand}"/>

                                                        <Label Text="{Binding WeekDateRange}"
                                                               FontSize="13"
                                                               TextColor="#7A7A7A"
                                                               VerticalOptions="Center"
                                                               HorizontalOptions="Start"
                                                               Margin="8,0,0,0"
                                                               Grid.Column="1"/>

                                                        <!-- Next week button -->
                                                        <Button Text="&gt;&gt;"
                                                                FontSize="16"
                                                                TextColor="#4A7BA7"
                                                                BackgroundColor="Transparent"
                                                                FontAttributes="Bold"
                                                                WidthRequest="40"
                                                                Padding="0"
                                                                Grid.Column="2"
                                                                Command="{Binding NextWeekCommand}"/>

                                                        <Button Text="History >"
                                                                FontSize="13"
                                                                TextColor="#FFA726"
                                                                BackgroundColor="Transparent"
                                                                Grid.Column="3"
                                                                Command="{Binding GoToDiaryHistoryCommand}"/>
                                                 </Grid>

                                                 <!-- Column Chart -->
                                                 <Grid ColumnDefinitions="*,*,*,*,*,*,*"
                                                       ColumnSpacing="8"
                                                       HeightRequest="140"
                                                       Margin="0,8,0,0">
                                                        <VerticalStackLayout Grid.Column="0"
                                                                             Spacing="4"
                                                                             VerticalOptions="End">
                                                               <Label Text="{Binding WeeklyPulseData[0].ScoreText}"
                                                                      FontSize="12"
                                                                      TextColor="#7A7A7A"
                                                                      FontAttributes="Bold"
                                                                      HorizontalOptions="Center"/>
                                                               <BoxView HeightRequest="{Binding WeeklyPulseData[0].Score, Converter={StaticResource ScoreToHeightConverter}}"
                                                                        BackgroundColor="#90CAF9"
                                                                        CornerRadius="6,6,0,0"
                                                                        WidthRequest="35"/>
                                                               <Label Text="Sun"
                                                                      FontSize="11"
                                                                      TextColor="#555"
                                                                      HorizontalOptions="Center"/>
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Grid.Column="1"
                                                                             Spacing="4"
                                                                             VerticalOptions="End">
                                                               <Label Text="{Binding WeeklyPulseData[1].ScoreText}"
                                                                      FontSize="12"
                                                                      TextColor="#7A7A7A"
                                                                      FontAttributes="Bold"
                                                                      HorizontalOptions="Center"/>
                                                               <BoxView HeightRequest="{Binding WeeklyPulseData[1].Score, Converter={StaticResource ScoreToHeightConverter}}"
                                                                        BackgroundColor="#90CAF9"
                                                                        CornerRadius="6,6,0,0"
                                                                        WidthRequest="35"/>
                                                               <Label Text="Mon"
                                                                      FontSize="11"
                                                                      TextColor="#555"
                                                                      HorizontalOptions="Center"/>
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Grid.Column="2"
                                                                             Spacing="4"
                                                                             VerticalOptions="End">
                                                               <Label Text="{Binding WeeklyPulseData[2].ScoreText}"
                                                                      FontSize="12"
                                                                      TextColor="#7A7A7A"
                                                                      FontAttributes="Bold"
                                                                      HorizontalOptions="Center"/>
                                                               <BoxView HeightRequest="{Binding WeeklyPulseData[2].Score, Converter={StaticResource ScoreToHeightConverter}}"
                                                                        BackgroundColor="#90CAF9"
                                                                        CornerRadius="6,6,0,0"
                                                                        WidthRequest="35"/>
                                                               <Label Text="Tue"
                                                                      FontSize="11"
                                                                      TextColor="#555"
                                                                      HorizontalOptions="Center"/>
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Grid.Column="3"
                                                                             Spacing="4"
                                                                             VerticalOptions="End">
                                                               <Label Text="{Binding WeeklyPulseData[3].ScoreText}"
                                                                      FontSize="12"
                                                                      TextColor="#7A7A7A"
                                                                      FontAttributes="Bold"
                                                                      HorizontalOptions="Center"/>
                                                               <BoxView HeightRequest="{Binding WeeklyPulseData[3].Score, Converter={StaticResource ScoreToHeightConverter}}"
                                                                        BackgroundColor="#90CAF9"
                                                                        CornerRadius="6,6,0,0"
                                                                        WidthRequest="35"/>
                                                               <Label Text="Wed"
                                                                      FontSize="11"
                                                                      TextColor="#555"
                                                                      HorizontalOptions="Center"/>
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Grid.Column="4"
                                                                             Spacing="4"
                                                                             VerticalOptions="End">
                                                               <Label Text="{Binding WeeklyPulseData[4].ScoreText}"
                                                                      FontSize="12"
                                                                      TextColor="#7A7A7A"
                                                                      FontAttributes="Bold"
                                                                      HorizontalOptions="Center"/>
                                                               <BoxView HeightRequest="{Binding WeeklyPulseData[4].Score, Converter={StaticResource ScoreToHeightConverter}}"
                                                                        BackgroundColor="#90CAF9"
                                                                        CornerRadius="6,6,0,0"
                                                                        WidthRequest="35"/>
                                                               <Label Text="Thu"
                                                                      FontSize="11"
                                                                      TextColor="#555"
                                                                      HorizontalOptions="Center"/>
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Grid.Column="5"
                                                                             Spacing="4"
                                                                             VerticalOptions="End">
                                                               <Label Text="{Binding WeeklyPulseData[5].ScoreText}"
                                                                      FontSize="12"
                                                                      TextColor="#7A7A7A"
                                                                      FontAttributes="Bold"
                                                                      HorizontalOptions="Center"/>
                                                               <BoxView HeightRequest="{Binding WeeklyPulseData[5].Score, Converter={StaticResource ScoreToHeightConverter}}"
                                                                        BackgroundColor="#90CAF9"
                                                                        CornerRadius="6,6,0,0"
                                                                        WidthRequest="35"/>
                                                               <Label Text="Fri"
                                                                      FontSize="11"
                                                                      TextColor="#555"
                                                                      HorizontalOptions="Center"/>
                                                        </VerticalStackLayout>

                                                        <VerticalStackLayout Grid.Column="6"
                                                                             Spacing="4"
                                                                             VerticalOptions="End">
                                                               <Label Text="{Binding WeeklyPulseData[6].ScoreText}"
                                                                      FontSize="12"
                                                                      TextColor="#7A7A7A"
                                                                      FontAttributes="Bold"
                                                                      HorizontalOptions="Center"/>
                                                               <BoxView HeightRequest="{Binding WeeklyPulseData[6].Score, Converter={StaticResource ScoreToHeightConverter}}"
                                                                        BackgroundColor="#90CAF9"
                                                                        CornerRadius="6,6,0,0"
                                                                        WidthRequest="35"/>
                                                               <Label Text="Sat"
                                                                      FontSize="11"
                                                                      TextColor="#555"
                                                                      HorizontalOptions="Center"/>
                                                        </VerticalStackLayout>
                                                 </Grid>
                                          </VerticalStackLayout>
                                   </Border>
                            </VerticalStackLayout>

                            <!-- Resonating Themes Section -->
                            <VerticalStackLayout Grid.Row="3"
                                                 Spacing="8"
                                                 Padding="24,0">
                                   <!-- Title outside card -->
                                   <Label Text="Resonating Themes"
                                          FontSize="28"
                                          FontFamily="mediumfont"
                                          TextColor="White"/>

                                   <!-- Themes Card -->
                                   <Border BackgroundColor="White"
                                           StrokeThickness="0"
                                           StrokeShape="RoundRectangle 18"
                                           Padding="20">
                                          <!-- Themes List -->
                                          <CollectionView ItemsSource="{Binding ResonatingThemes}"
                                                          SelectionMode="None">
                                                 <CollectionView.ItemTemplate>
                                                        <DataTemplate>
                                                               <Border StrokeThickness="0"
                                                                       StrokeShape="RoundRectangle 16"
                                                                       Padding="0"
                                                                       HeightRequest="80"
                                                                       Margin="0,6"
                                                                       BackgroundColor="{Binding BackgroundColor}">
                                                                      <!-- Combined Grid with progress bar background and content overlay -->
                                                                      <Grid RowDefinitions="*"
                                                                            ColumnDefinitions="*">
                                                                             <!-- Progress bar background with opacity -->
                                                                             <BoxView Grid.Row="0"
                                                                                      Grid.Column="0"
                                                                                      BackgroundColor="{Binding BackgroundColor}"
                                                                                      Opacity="0.7"
                                                                                      WidthRequest="{Binding Percentage, Converter={StaticResource ProgressToDoubleConverter}}"
                                                                                      HorizontalOptions="Start"
                                                                                      VerticalOptions="Fill"/>
                                                                             <!-- Content on top of progress bar -->
                                                                             <Grid Grid.Row="0"
                                                                                   Grid.Column="0"
                                                                                   RowDefinitions="Auto,Auto"
                                                                                   ColumnDefinitions="*,Auto"
                                                                                   Padding="16,8">
                                                                                    <!-- Theme name - top left -->
                                                                                    <Label Text="{Binding ThemeName}"
                                                                                           FontSize="16"
                                                                                           TextColor="#2B638D"
                                                                                           FontAttributes="Bold"
                                                                                           VerticalOptions="Start"
                                                                                           Grid.Row="0"
                                                                                           Grid.Column="0"
                                                                                           Margin="0,0,0,8"/>
                                                                                    <!-- Count - bottom left -->
                                                                                    <Label Text="{Binding Count}"
                                                                                           FontSize="11"
                                                                                           FontAttributes="Bold"
                                                                                           TextColor="#4A7BA7"
                                                                                           VerticalOptions="End"
                                                                                           Grid.Row="1"
                                                                                           Grid.Column="0"/>
                                                                                    <!-- Percentage - bottom right -->
                                                                                    <Label Text="{Binding PercentageText}"
                                                                                           FontSize="20"
                                                                                           FontAttributes="Bold"
                                                                                           TextColor="#4A7BA7"
                                                                                           VerticalOptions="End"
                                                                                           Grid.Row="1"
                                                                                           Grid.Column="1"/>
                                                                             </Grid>
                                                                      </Grid>
                                                               </Border>
                                                        </DataTemplate>
                                                 </CollectionView.ItemTemplate>
                                          </CollectionView>
                                   </Border>
                            </VerticalStackLayout>
                     </Grid>
              </ScrollView>


              <!-- Back Button - Fixed position outside ScrollView -->
              <ImageButton Grid.Row="0"
                           Source="back.png"
                           WidthRequest="80"
                           HeightRequest="80"
                           HorizontalOptions="Start"
                           VerticalOptions="Start"
                           BackgroundColor="Transparent"
                           Margin="10,20,0,0"
                           Clicked="OnBackClicked"/>
       </Grid>


</ContentPage>