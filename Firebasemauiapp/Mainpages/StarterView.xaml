<?xml version="1.0" encoding="utf-8"?>
<ContentPage
    x:Class="Firebasemauiapp.Mainpages.StarterView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Name="Root"
    Title="StarterView"
    Shell.FlyoutBehavior="Disabled"
    Shell.NavBarIsVisible="False"
    Shell.BackgroundColor="Transparent"
    BackgroundColor="{AppThemeBinding Light=White, Dark=#4F5259}">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False"
                            IsEnabled="False"/>
    </Shell.BackButtonBehavior>

    <Grid>
        <Grid Padding="16,50,16,0"
              RowSpacing="0"
              RowDefinitions="Auto,Auto,*">

        <!-- ===== HEADER ===== -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="Auto, *"
              RowDefinitions="Auto"
              Margin="0,0,0,0">

            <!-- Left: Plant & Pot -->
            <Grid Grid.Column="0"
                  WidthRequest="160"
                  HeightRequest="170"
                  VerticalOptions="End">
                 <!-- Pot (Behind) -->
                <Image Source="{Binding CurrentPotImage}"
                       Aspect="AspectFit"
                       VerticalOptions="End"
                       HorizontalOptions="Center"
                       WidthRequest="160"
                       HeightRequest="170"
                       Margin="0,0,0,0"/>
                 <!-- Plant (Front) -->
                 <Image Source="{Binding CurrentPlantImage}"
                        Aspect="AspectFit"
                        VerticalOptions="End"
                        HorizontalOptions="Center"
                        WidthRequest="160"
                        HeightRequest="170"
                        Margin="0,0,0,45"/>
            </Grid>

            <!-- Right: Text & Settings -->
            <Grid Grid.Column="1" 
                  HeightRequest="170"
                  VerticalOptions="End"
                  RowDefinitions="Auto"
                  Padding="16,0,0,0">
                  
                  <!-- Settings Icon (Top Right overlay) -->
                  <Grid Grid.Row="0"
                        WidthRequest="40"
                        HeightRequest="40"
                        HorizontalOptions="End"
                        VerticalOptions="Start"
                        TranslationY="-25"
                        BackgroundColor="Transparent">
                      <Grid.GestureRecognizers>
                          <TapGestureRecognizer Command="{Binding OpenSettingsCommand}"/>
                      </Grid.GestureRecognizers>
                      <Image Source="settings.png"
                             HeightRequest="18"
                             WidthRequest="18"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"
                             Aspect="AspectFit"/>
                  </Grid>

                  <!-- Combined Text Stack (Bottom Aligned) -->
                  <VerticalStackLayout Grid.Row="0" 
                                       VerticalOptions="End" 
                                       Spacing="2">
                        <Label Text="Welcome Home,"
                               FontSize="28"
                               FontAttributes="Bold"
                               FontFamily="contextfont"
                               TextColor="#8FAF8B"/>
                        <Label Text="{Binding WelcomeMessage, StringFormat='{0}.'}"
                               FontSize="28"
                               FontAttributes="Bold"
                               FontFamily="contextfont"
                               TextColor="#8FAF8B"
                               LineBreakMode="TailTruncation"/>
                        <Label Text="Your safe space is ready."
                               FontSize="16"
                               FontFamily="regularfont"
                               TextColor="#A9BEA6"
                               Margin="0,4,0,5"/>
                  </VerticalStackLayout>
            </Grid>
        </Grid>

        <ScrollView Grid.Row="1"
                    Grid.RowSpan="2">
            <VerticalStackLayout Spacing="10">
                <!-- ===== DIARY BUTTON (FULL WIDTH) ===== -->
                <Border StrokeShape="RoundRectangle 20"
                        StrokeThickness="0"
                        HeightRequest="140"
                        Margin="0,4,0,0"
                        BackgroundColor="Transparent">
                    <Grid>
                        <Image Source="btn_diary.png"
                               Aspect="AspectFill"
                               HorizontalOptions="Fill"
                               VerticalOptions="Fill"/>
                        <Button BackgroundColor="Transparent"
                                Command="{Binding GoDiaryCommand}"/>
                    </Grid>
                </Border>

                <!-- ===== GRID BUTTONS ===== -->
                <Grid
                    ColumnSpacing="10"
                    RowSpacing="6"
                    ColumnDefinitions="*,*"
                    RowDefinitions="140,70,140">

                    <!-- Quests (left top) -->
                    <Border Grid.Row="0"
                            Grid.Column="0"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0"
                            HeightRequest="140"
                            BackgroundColor="Transparent">
                        <Grid>
                            <Image Source="btn_quest.png"
                                   Aspect="AspectFill"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill"/>
                            <Button BackgroundColor="Transparent"
                                    Command="{Binding GoQuestCommand}"/>
                        </Grid>
                    </Border>

                    <!-- Store (Right bottom) -->
                    <Border Grid.Row="2"
                            Grid.Column="1"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0"
                            HeightRequest="140"
                            BackgroundColor="Transparent">
                        <Grid>
                            <Image Source="btn_store.png"
                                   Aspect="AspectFill"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill"/>
                            <Button BackgroundColor="Transparent"
                                    Command="{Binding GoStoreCommand}"/>
                        </Grid>
                    </Border>

                    <!-- Mind Dashboard (right top-middle) -->
                    <Border Grid.Row="0"
                            Grid.Column="1"
                            Grid.RowSpan="2"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0"
                            HeightRequest="210"
                            BackgroundColor="Transparent">
                        <Grid>
                            <Image Source="btn_dashboard.png"
                                   Aspect="AspectFill"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill"/>
                            <Button BackgroundColor="Transparent"
                                    Command="{Binding GoDashboardCommand}"/>
                        </Grid>
                    </Border>

                    <!-- Kindness Forest (left middle-bottom) -->
                    <Border Grid.Row="1"
                            Grid.Column="0"
                            Grid.RowSpan="2"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0"
                            HeightRequest="210"
                            BackgroundColor="Transparent">
                        <Grid>
                            <Image Source="btn_forest.png"
                                   Aspect="AspectFill"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill"/>
                            <Button BackgroundColor="Transparent"
                                    Command="{Binding GoForestCommand}"/>
                        </Grid>
                    </Border>
                </Grid>
            </VerticalStackLayout>
        </ScrollView>

        </Grid>

        <!-- Settings Overlay -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsSettingsOpen}"
              ZIndex="900">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseSettingsCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <Frame.Triggers>
                       <DataTrigger TargetType="Frame" Binding="{Binding IsLightMode}" Value="True">
                           <Setter Property="BackgroundColor" Value="White"/>
                       </DataTrigger>
                       <DataTrigger TargetType="Frame" Binding="{Binding IsLightMode}" Value="False">
                           <Setter Property="BackgroundColor" Value="#4F5259"/>
                       </DataTrigger>
                   </Frame.Triggers>
                   <Frame.GestureRecognizers>
                       <TapGestureRecognizer />
                   </Frame.GestureRecognizers>
                   
                   <VerticalStackLayout Spacing="24">
                       

                       <!-- Icon: Sun for Light, Moon for Dark -->
                       <Image HeightRequest="60"
                              WidthRequest="60"
                              HorizontalOptions="Center"
                              Margin="0,0,0,0">
                              <Image.Triggers>
                                  <DataTrigger TargetType="Image" Binding="{Binding IsLightMode}" Value="True">
                                      <Setter Property="Source" Value="sun.png"/>
                                  </DataTrigger>
                                  <DataTrigger TargetType="Image" Binding="{Binding IsLightMode}" Value="False">
                                      <Setter Property="Source" Value="moon.png"/>
                                  </DataTrigger>
                              </Image.Triggers>
                       </Image>
                       <!-- Title -->
                       <Label Text="Choose a style"
                              FontSize="20"
                              FontAttributes="Bold"
                              TextColor="#8FAF8B"
                              FontFamily="contextfont"
                              HorizontalOptions="Center"
                              Margin="0,-10,0,0"/>

                       <!-- Toggle Switch -->
                       <Border BackgroundColor="#F5F5F5"
                               StrokeThickness="0"
                               StrokeShape="RoundRectangle 20"
                               HeightRequest="44"
                               WidthRequest="220"
                               HorizontalOptions="Center"
                               Padding="2">
                           <Grid ColumnDefinitions="*,*">
                               <!-- Light -->
                               <Grid Grid.Column="0">
                                   <BoxView Color="White" CornerRadius="18" Margin="1">
                                        <BoxView.Triggers>
                                            <DataTrigger TargetType="BoxView" Binding="{Binding IsLightMode}" Value="False">
                                                <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                        </BoxView.Triggers>
                                        <BoxView.Shadow>
                                            <Shadow Brush="Black" Opacity="0.1" Radius="2" Offset="0,1"/>
                                        </BoxView.Shadow>
                                   </BoxView>
                                   <Label Text="Light" VerticalOptions="Center" HorizontalOptions="Center" FontAttributes="Bold">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="True">
                                                <Setter Property="TextColor" Value="#8FAF8B"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="False">
                                                <Setter Property="TextColor" Value="#A0A0A0"/>
                                            </DataTrigger>
                                        </Label.Triggers>
                                   </Label>
                                   <Grid.GestureRecognizers>
                                       <TapGestureRecognizer Command="{Binding SetLightThemeCommand}"/>
                                   </Grid.GestureRecognizers>
                               </Grid>


                               <!-- Dark -->
                               <Grid Grid.Column="1">
                                   <BoxView Color="#A0A0A0" CornerRadius="18" Margin="1">
                                        <BoxView.Triggers>
                                            <DataTrigger TargetType="BoxView" Binding="{Binding IsLightMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                        </BoxView.Triggers>
                                   </BoxView>
                                   <Label Text="Dark" VerticalOptions="Center" HorizontalOptions="Center" FontAttributes="Bold">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="False">
                                                <Setter Property="TextColor" Value="White"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="True">
                                                <Setter Property="TextColor" Value="#A0A0A0"/>
                                            </DataTrigger>
                                        </Label.Triggers>
                                   </Label>
                                   <Grid.GestureRecognizers>
                                       <TapGestureRecognizer Command="{Binding SetDarkThemeCommand}"/>
                                   </Grid.GestureRecognizers>
                               </Grid>
                           </Grid>
                       </Border>
                        <!-- Change Password Button (Hidden for Google Users) -->
                        <Button Text="Change Password" 
                                Command="{Binding OpenChangePasswordCommand}"
                                BackgroundColor="Transparent"
                                TextColor="#8FAF8B"
                                BorderColor="#E0E0E0"
                                BorderWidth="1"
                                CornerRadius="22"
                                HeightRequest="50"
                                FontAttributes="Bold"
                                FontSize="16"
                                IsVisible="{Binding IsGoogleUser, Converter={StaticResource InvertedBoolConverter}}"/>

                        <!-- Logout Button -->
                       <Button Text="Logout" 
                               Command="{Binding ShowLogoutConfirmationCommand}"
                               BackgroundColor="#E4000F"
                               TextColor="#FFFFFF"
                               BorderColor="#E0E0E0"
                               BorderWidth="1"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"
                               FontSize="16"/>
                        <!-- Delete Account Button -->
                       <Button Text="Delete Account" 
                               Command="{Binding ShowDeleteConfirmationCommand}"
                               BackgroundColor="Transparent"
                               TextColor="#E4000F"
                               BorderColor="Transparent"
                               BorderWidth="0"
                               HeightRequest="40"
                               FontAttributes="Bold"
                               FontSize="14"
                               Margin="0,-10,0,0"/>
                       <!-- Close Popup Button -->
                       <Button Text="Okay" 
                               Command="{Binding CloseSettingsCommand}"
                               BackgroundColor="White"
                               TextColor="#8FAF8B"
                               BorderColor="#E0E0E0"
                               BorderWidth="1"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"
                               FontSize="16"/>

                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Delete Confirmation Overlay 1 -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsDeleteConfirmationOpen}"
              ZIndex="910">
            <Grid.GestureRecognizers>
                <!-- Tap outside to close? user didn't specify, but good UX usually allows or forces choice. 
                     The design implies modal, so maybe force choice. I will bind to close for safety/easy exit. -->
                <TapGestureRecognizer Command="{Binding CloseDeleteConfirmationCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <VerticalStackLayout Spacing="20">
                       <!-- Trash Icon -->
                       <Image Source="trash.png" 
                              FontSize="80" 
                              HorizontalOptions="Center"
                              TextColor="#E4000F"/>
                       
                       <Label Text="Are you sure you want to delete your account?"
                              FontSize="18"
                              FontAttributes="Bold"
                              TextColor="#E4000F"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Button Text="Yes, Delete"
                               Command="{Binding ShowFinalDeleteConfirmationCommand}"
                               BackgroundColor="#E4000F"
                               TextColor="White"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>

                       <Button Text="Keep Account"
                               Command="{Binding CloseDeleteConfirmationCommand}"
                               BackgroundColor="White"
                               TextColor="#8FAF8B"
                               BorderColor="#E0E0E0"
                               BorderWidth="1"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>
                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Final Delete Confirmation Overlay 2 -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsFinalDeleteConfirmationOpen}"
              ZIndex="920">
             <!-- Prevent closing by tapping background to ensure intentionality? 
                  User flow shows 'x' button in design usually, but here I'll add a close button or allow background tap.
                  I'll allow background tap for consistency. -->
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseDeleteConfirmationCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <VerticalStackLayout Spacing="15">
                       <!-- Close Button (Top Right) - Optional based on design, but good practice. 
                            Implementing simple layout. -->
                       <Grid>
                           <Image Source="warning.png" 
                                  FontSize="50" 
                                  HorizontalOptions="Center"
                                  TextColor="#E4000F"/>
                           <ImageButton Source="close_icon.png" 
                                        HeightRequest="20" 
                                        WidthRequest="20" 
                                        HorizontalOptions="End" 
                                        VerticalOptions="Start"
                                        BackgroundColor="Transparent"
                                        Command="{Binding CloseDeleteConfirmationCommand}"
                                        IsVisible="False"/> <!-- Hidden for now as asset unknown -->
                       </Grid>

                       <Label Text="Confirm Account Deletion"
                              FontSize="20"
                              FontAttributes="Bold"
                              TextColor="#E4000F"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Label Text="To confirm deletion, type &#x0a;&quot;delete&quot; below:"
                              FontSize="16"
                              TextColor="#E4000F"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Entry Text="{Binding DeleteConfirmationInput}"
                              Placeholder="delete"
                              HorizontalTextAlignment="Center"
                              HeightRequest="50"/>

                        <!-- Error Message -->
                       <Label Text="{Binding DeleteErrorMessage}"
                              TextColor="Red"
                              FontSize="14"
                              HorizontalOptions="Center"
                              IsVisible="{Binding HasDeleteError}"/>

                       <Button Text="Confirm and delete"
                               Command="{Binding ExecuteDeleteAccountCommand}"
                               BackgroundColor="#E4000F"
                               TextColor="White"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"
                               Margin="0,10,0,0"/>
                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Logout Confirmation Overlay -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsLogoutConfirmationOpen}"
              ZIndex="915">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseLogoutConfirmationCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <VerticalStackLayout Spacing="20">
                       <!-- Logout Icon -->
                       <Image Source="logout.png"
                              HeightRequest="80"
                              WidthRequest="80"
                              HorizontalOptions="Center"/>
                       
                       <Label Text="Oh no! You're leaving...&#x0a;Are you sure?"
                              FontSize="18"
                              FontAttributes="Bold"
                              TextColor="#8FAF8B"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Button Text="No, Stay"
                               Command="{Binding CloseLogoutConfirmationCommand}"
                               BackgroundColor="#8FAF8B"
                               TextColor="White"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>

                       <Button Text="Yes, Log Out"
                               Command="{Binding LogOutCommand}"
                               BackgroundColor="White"
                               TextColor="#8FAF8B"
                               BorderColor="#8FAF8B"
                               BorderWidth="2"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>
                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Loading Overlay -->
        <Grid BackgroundColor="#F0FFFFFF"
              IsVisible="{Binding IsLoading}"
              InputTransparent="False"
              ZIndex="999">
             <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="20">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   Color="#8FAF8B"
                                   HeightRequest="50"
                                   WidthRequest="50"/>
                <Label Text="Getting things ready..." 
                       TextColor="#8FAF8B" 
                       FontSize="18"
                       FontAttributes="Bold"
                       FontFamily="mediumfont"
                       HorizontalOptions="Center"/>
             </VerticalStackLayout>
        </Grid>
        <!-- Change Password Overlay -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsChangePasswordOpen}"
              ZIndex="950">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseChangePasswordCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="320"
                   HasShadow="False">
                <VerticalStackLayout Spacing="16">
                    <Label Text="Change Password"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="#8FAF8B"
                           HorizontalOptions="Center"/>

                    <!-- Old Password -->
                    <Border Stroke="#E0E0E0" StrokeShape="RoundRectangle 12" HeightRequest="44" Padding="12,0">
                        <Entry Placeholder="Old Password"
                               Text="{Binding OldPassword}"
                               IsPassword="True"
                               TextColor="#333333"/>
                    </Border>

                    <!-- New Password -->
                    <Border Stroke="#E0E0E0" StrokeShape="RoundRectangle 12" HeightRequest="44" Padding="12,0">
                        <Entry Placeholder="New Password"
                               Text="{Binding NewPassword}"
                               IsPassword="True"
                               TextColor="#333333"/>
                    </Border>

                    <!-- Confirm Password -->
                    <Border Stroke="#E0E0E0" StrokeShape="RoundRectangle 12" HeightRequest="44" Padding="12,0">
                        <Entry Placeholder="Confirm Password"
                               Text="{Binding ConfirmPassword}"
                               IsPassword="True"
                               TextColor="#333333"/>
                    </Border>

                    <HorizontalStackLayout Spacing="12" HorizontalOptions="Center" Margin="0,10,0,0">
                        <Button Text="Cancel"
                                Command="{Binding CloseChangePasswordCommand}"
                                BackgroundColor="Transparent"
                                TextColor="#8A8A8A"/>
                        <Button Text="Confirm"
                                Command="{Binding SubmitChangePasswordCommand}"
                                BackgroundColor="#FEAA3A"
                                TextColor="White"
                                CornerRadius="20"
                                WidthRequest="120"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>
