<?xml version="1.0" encoding="utf-8"?>
<ContentPage
    x:Class="Firebasemauiapp.Mainpages.StarterView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Name="Root"
    Title="StarterView"
    Shell.FlyoutBehavior="Disabled"
    Shell.NavBarIsVisible="False"
    Shell.BackgroundColor="Transparent"
    BackgroundColor="{AppThemeBinding Light=White, Dark=#4F5259}">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior IsVisible="False"
                            IsEnabled="False"/>
    </Shell.BackButtonBehavior>

    <Grid>
        <Grid Padding="16,12,16,0"
              RowSpacing="10"
              RowDefinitions="Auto,Auto,*">

        <!-- ===== HEADER ===== -->
        <VerticalStackLayout Grid.Row="0"
                             Spacing="6">

            <Grid ColumnDefinitions="*,Auto">
                <!-- Logo -->
                <Image Source="logo.png"
                       HeightRequest="80"
                       WidthRequest="100"
                       Margin="10,5,0,0"
                       HorizontalOptions="Start"/>
                
                <!-- Settings Button -->
                <ImageButton Grid.Column="1"
                        Source="settings.png"
                        BackgroundColor="Transparent"
                        HeightRequest="20"
                        WidthRequest="20"
                        VerticalOptions="Center"
                        Margin="0,0,10,0"
                        Command="{Binding OpenSettingsCommand}"/>
            </Grid>


            <!-- Welcome Text -->
            <Label Text="Welcome Home,"
                   FontSize="32"
                   FontAttributes="Bold"
                   FontFamily="contextfont"
                   TextColor="#8FAF8B"
                   LineHeight="1.0"/>
            <Label Text="{Binding WelcomeMessage}"
                   FontSize="32"
                   FontAttributes="Bold"
                   FontFamily="contextfont"
                   TextColor="#8FAF8B"
                   LineHeight="1.0"
                   Margin="0,-8,0,0"/>

            <!-- Subtitle -->
            <Label Text="Your safe space is ready."
                   FontSize="16"
                   FontFamily="regularfont"
                   TextColor="#A9BEA6"/>

        </VerticalStackLayout>

        <ScrollView Grid.Row="1"
                    Grid.RowSpan="2">
            <VerticalStackLayout Spacing="10">
                <!-- ===== DIARY BUTTON (FULL WIDTH) ===== -->
                <ImageButton
                    Source="btn_diary.png"
                    Aspect="AspectFill"
                    CornerRadius="28"
                    HeightRequest="140"
                    Padding="0"
                    Margin="0,4,0,0"
                    BackgroundColor="Transparent"
                    Command="{Binding GoDiaryCommand}"/>

                <!-- ===== GRID BUTTONS ===== -->
                <Grid
                    ColumnSpacing="10"
                    RowSpacing="6"
                    ColumnDefinitions="*,*"
                    RowDefinitions="140,70,140">

                    <!-- Quests (left top) -->
                    <ImageButton Grid.Row="0"
                                 Grid.Column="0"
                                 Source="btn_quest.png"
                                 Aspect="AspectFill"
                                 CornerRadius="28"
                                 HeightRequest="140"
                                 Padding="0"
                                 VerticalOptions="Start"
                                 BackgroundColor="Transparent"
                                 Command="{Binding GoQuestCommand}"/>

                    <!-- Store (Right bottom) -->
                    <ImageButton Grid.Row="2"
                                 Grid.Column="1"
                                 Source="btn_store.png"
                                 Aspect="AspectFill"
                                 CornerRadius="28"
                                 HeightRequest="140"
                                 Padding="0"
                                 BackgroundColor="Transparent"
                                 Command="{Binding GoStoreCommand}"/>

                    <!-- Mind Dashboard (right top-middle) -->
                    <ImageButton Grid.Row="0"
                                 Grid.Column="1"
                                 Grid.RowSpan="2"
                                 Source="btn_dashboard.png"
                                 Aspect="AspectFill"
                                 CornerRadius="28"
                                 HeightRequest="210"
                                 Padding="0"
                                 VerticalOptions="Start"
                                 BackgroundColor="Transparent"
                                 Command="{Binding GoDashboardCommand}"/>

                    <!-- Kindness Forest (left middle-bottom) -->
                    <ImageButton Grid.Row="1"
                                 Grid.Column="0"
                                 Grid.RowSpan="2"
                                 Source="btn_forest.png"
                                 Aspect="AspectFill"
                                 CornerRadius="28"
                                 HeightRequest="210"
                                 Padding="0"
                                 BackgroundColor="Transparent"
                                 Command="{Binding GoForestCommand}"/>
                </Grid>
            </VerticalStackLayout>
        </ScrollView>

        </Grid>

        <!-- Settings Overlay -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsSettingsOpen}"
              ZIndex="900">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseSettingsCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <Frame.Triggers>
                       <DataTrigger TargetType="Frame" Binding="{Binding IsLightMode}" Value="True">
                           <Setter Property="BackgroundColor" Value="White"/>
                       </DataTrigger>
                       <DataTrigger TargetType="Frame" Binding="{Binding IsLightMode}" Value="False">
                           <Setter Property="BackgroundColor" Value="#4F5259"/>
                       </DataTrigger>
                   </Frame.Triggers>
                   <Frame.GestureRecognizers>
                       <TapGestureRecognizer />
                   </Frame.GestureRecognizers>
                   
                   <VerticalStackLayout Spacing="24">
                       

                       <!-- Icon: Sun for Light, Moon for Dark -->
                       <Image HeightRequest="60"
                              WidthRequest="60"
                              HorizontalOptions="Center"
                              Margin="0,0,0,0">
                              <Image.Triggers>
                                  <DataTrigger TargetType="Image" Binding="{Binding IsLightMode}" Value="True">
                                      <Setter Property="Source" Value="sun.png"/>
                                  </DataTrigger>
                                  <DataTrigger TargetType="Image" Binding="{Binding IsLightMode}" Value="False">
                                      <Setter Property="Source" Value="moon.png"/>
                                  </DataTrigger>
                              </Image.Triggers>
                       </Image>
                       <!-- Title -->
                       <Label Text="Choose a style"
                              FontSize="20"
                              FontAttributes="Bold"
                              TextColor="#8FAF8B"
                              FontFamily="contextfont"
                              HorizontalOptions="Center"
                              Margin="0,-10,0,0"/>

                       <!-- Toggle Switch -->
                       <Border BackgroundColor="#F5F5F5"
                               StrokeThickness="0"
                               StrokeShape="RoundRectangle 20"
                               HeightRequest="44"
                               WidthRequest="220"
                               HorizontalOptions="Center"
                               Padding="2">
                           <Grid ColumnDefinitions="*,*">
                               <!-- Light -->
                               <Grid Grid.Column="0">
                                   <BoxView Color="White" CornerRadius="18" Margin="1">
                                        <BoxView.Triggers>
                                            <DataTrigger TargetType="BoxView" Binding="{Binding IsLightMode}" Value="False">
                                                <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                        </BoxView.Triggers>
                                        <BoxView.Shadow>
                                            <Shadow Brush="Black" Opacity="0.1" Radius="2" Offset="0,1"/>
                                        </BoxView.Shadow>
                                   </BoxView>
                                   <Label Text="Light" VerticalOptions="Center" HorizontalOptions="Center" FontAttributes="Bold">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="True">
                                                <Setter Property="TextColor" Value="#8FAF8B"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="False">
                                                <Setter Property="TextColor" Value="#A0A0A0"/>
                                            </DataTrigger>
                                        </Label.Triggers>
                                   </Label>
                                   <Grid.GestureRecognizers>
                                       <TapGestureRecognizer Command="{Binding SetLightThemeCommand}"/>
                                   </Grid.GestureRecognizers>
                               </Grid>


                               <!-- Dark -->
                               <Grid Grid.Column="1">
                                   <BoxView Color="#A0A0A0" CornerRadius="18" Margin="1">
                                        <BoxView.Triggers>
                                            <DataTrigger TargetType="BoxView" Binding="{Binding IsLightMode}" Value="True">
                                                <Setter Property="IsVisible" Value="False"/>
                                            </DataTrigger>
                                        </BoxView.Triggers>
                                   </BoxView>
                                   <Label Text="Dark" VerticalOptions="Center" HorizontalOptions="Center" FontAttributes="Bold">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="False">
                                                <Setter Property="TextColor" Value="White"/>
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsLightMode}" Value="True">
                                                <Setter Property="TextColor" Value="#A0A0A0"/>
                                            </DataTrigger>
                                        </Label.Triggers>
                                   </Label>
                                   <Grid.GestureRecognizers>
                                       <TapGestureRecognizer Command="{Binding SetDarkThemeCommand}"/>
                                   </Grid.GestureRecognizers>
                               </Grid>
                           </Grid>
                       </Border>
                        <!-- Logout Button -->
                       <Button Text="Logout" 
                               Command="{Binding ShowLogoutConfirmationCommand}"
                               BackgroundColor="#E4000F"
                               TextColor="#FFFFFF"
                               BorderColor="#E0E0E0"
                               BorderWidth="1"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"
                               FontSize="16"/>
                        <!-- Delete Account Button -->
                       <Button Text="Delete Account" 
                               Command="{Binding ShowDeleteConfirmationCommand}"
                               BackgroundColor="Transparent"
                               TextColor="#E4000F"
                               BorderColor="Transparent"
                               BorderWidth="0"
                               HeightRequest="40"
                               FontAttributes="Bold"
                               FontSize="14"
                               Margin="0,-10,0,0"/>
                       <!-- Close Popup Button -->
                       <Button Text="Okay" 
                               Command="{Binding CloseSettingsCommand}"
                               BackgroundColor="White"
                               TextColor="#8FAF8B"
                               BorderColor="#E0E0E0"
                               BorderWidth="1"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"
                               FontSize="16"/>

                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Delete Confirmation Overlay 1 -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsDeleteConfirmationOpen}"
              ZIndex="910">
            <Grid.GestureRecognizers>
                <!-- Tap outside to close? user didn't specify, but good UX usually allows or forces choice. 
                     The design implies modal, so maybe force choice. I will bind to close for safety/easy exit. -->
                <TapGestureRecognizer Command="{Binding CloseDeleteConfirmationCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <VerticalStackLayout Spacing="20">
                       <!-- Trash Icon -->
                       <Image Source="trash.png" 
                              FontSize="80" 
                              HorizontalOptions="Center"
                              TextColor="#E4000F"/>
                       
                       <Label Text="Are you sure you want to delete your account?"
                              FontSize="18"
                              FontAttributes="Bold"
                              TextColor="#E4000F"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Button Text="Yes, Delete"
                               Command="{Binding ShowFinalDeleteConfirmationCommand}"
                               BackgroundColor="#E4000F"
                               TextColor="White"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>

                       <Button Text="Keep Account"
                               Command="{Binding CloseDeleteConfirmationCommand}"
                               BackgroundColor="White"
                               TextColor="#8FAF8B"
                               BorderColor="#E0E0E0"
                               BorderWidth="1"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>
                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Final Delete Confirmation Overlay 2 -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsFinalDeleteConfirmationOpen}"
              ZIndex="920">
             <!-- Prevent closing by tapping background to ensure intentionality? 
                  User flow shows 'x' button in design usually, but here I'll add a close button or allow background tap.
                  I'll allow background tap for consistency. -->
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseDeleteConfirmationCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <VerticalStackLayout Spacing="15">
                       <!-- Close Button (Top Right) - Optional based on design, but good practice. 
                            Implementing simple layout. -->
                       <Grid>
                           <Image Source="warning.png" 
                                  FontSize="50" 
                                  HorizontalOptions="Center"
                                  TextColor="#E4000F"/>
                           <ImageButton Source="close_icon.png" 
                                        HeightRequest="20" 
                                        WidthRequest="20" 
                                        HorizontalOptions="End" 
                                        VerticalOptions="Start"
                                        BackgroundColor="Transparent"
                                        Command="{Binding CloseDeleteConfirmationCommand}"
                                        IsVisible="False"/> <!-- Hidden for now as asset unknown -->
                       </Grid>

                       <Label Text="Confirm Account Deletion"
                              FontSize="20"
                              FontAttributes="Bold"
                              TextColor="#E4000F"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Label Text="To confirm deletion, type &#x0a;&quot;delete&quot; below:"
                              FontSize="16"
                              TextColor="#E4000F"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Entry Text="{Binding DeleteConfirmationInput}"
                              Placeholder="delete"
                              HorizontalTextAlignment="Center"
                              HeightRequest="50"/>

                        <!-- Error Message -->
                       <Label Text="{Binding DeleteErrorMessage}"
                              TextColor="Red"
                              FontSize="14"
                              HorizontalOptions="Center"
                              IsVisible="{Binding HasDeleteError}"/>

                       <Button Text="Confirm and delete"
                               Command="{Binding ExecuteDeleteAccountCommand}"
                               BackgroundColor="#E4000F"
                               TextColor="White"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"
                               Margin="0,10,0,0"/>
                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Logout Confirmation Overlay -->
        <Grid BackgroundColor="#80000000"
              IsVisible="{Binding IsLogoutConfirmationOpen}"
              ZIndex="915">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseLogoutConfirmationCommand}"/>
            </Grid.GestureRecognizers>

            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   BackgroundColor="White"
                   CornerRadius="24"
                   Padding="30"
                   WidthRequest="300"
                   HasShadow="False">
                   <VerticalStackLayout Spacing="20">
                       <!-- Logout Icon -->
                       <Image Source="logout.png"
                              HeightRequest="80"
                              WidthRequest="80"
                              HorizontalOptions="Center"/>
                       
                       <Label Text="Oh no! You're leaving...&#x0a;Are you sure?"
                              FontSize="18"
                              FontAttributes="Bold"
                              TextColor="#8FAF8B"
                              HorizontalOptions="Center"
                              HorizontalTextAlignment="Center"/>

                       <Button Text="No, Stay"
                               Command="{Binding CloseLogoutConfirmationCommand}"
                               BackgroundColor="#8FAF8B"
                               TextColor="White"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>

                       <Button Text="Yes, Log Out"
                               Command="{Binding LogOutCommand}"
                               BackgroundColor="White"
                               TextColor="#8FAF8B"
                               BorderColor="#8FAF8B"
                               BorderWidth="2"
                               CornerRadius="22"
                               HeightRequest="50"
                               FontAttributes="Bold"/>
                   </VerticalStackLayout>
            </Frame>
        </Grid>

        <!-- Loading Overlay -->
        <Grid BackgroundColor="#F0FFFFFF"
              IsVisible="{Binding IsLoading}"
              InputTransparent="False"
              ZIndex="999">
             <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="20">
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                   Color="#8FAF8B"
                                   HeightRequest="50"
                                   WidthRequest="50"/>
                <Label Text="Getting things ready..." 
                       TextColor="#8FAF8B" 
                       FontSize="18"
                       FontAttributes="Bold"
                       FontFamily="mediumfont"
                       HorizontalOptions="Center"/>
             </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
